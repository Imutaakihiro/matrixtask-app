# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術 | バージョン |
|------|-----------|
| Node.js | v24.11.0 |
| TypeScript | 5.x |
| npm | 11.x |

### フレームワーク・ライブラリ

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| React | 18.x | UIフレームワーク | コンポーネントベースで再利用性が高い。豊富なエコシステムと実績。Hooksによる状態管理が直感的 |
| Vite | 5.x | ビルドツール | 高速な開発サーバー。TypeScript標準サポート。HMR（Hot Module Replacement）が爆速 |
| Zustand | 4.x | 状態管理 | 軽量（3KB）。TypeScript親和性が高い。Reduxより学習コスト低。不要なre-renderを防ぐ |
| dnd kit | 6.x | ドラッグ&ドロップ | モダンなAPI。アクセシビリティ対応。パフォーマンスが優れている。React 18対応 |
| Tailwind CSS | 3.x | CSSフレームワーク | ユーティリティファースト。Notionライクなシンプルデザインに最適。バンドルサイズ削減 |
| date-fns | 3.x | 日付処理 | 軽量。ツリーシェイキング対応。immutableなAPI。TypeScript型定義が優秀 |

### 開発ツール

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| ESLint | 9.x | コード品質 | 静的解析でバグを早期発見。TypeScript対応。カスタマイズ可能 |
| Prettier | 3.x | コードフォーマット | コードスタイルの統一。ESLintと連携。保存時自動整形 |
| Vitest | 1.x | ユニットテスト | Viteネイティブ。高速。JestライクなAPI。TypeScript標準サポート |
| Playwright | 1.x | E2Eテスト | クロスブラウザ対応。並列実行。デバッグツールが強力 |

## アーキテクチャパターン

### レイヤードアーキテクチャ

```
┌─────────────────────────────────────┐
│   UIレイヤー (React Components)      │ ← ユーザー操作、表示
├─────────────────────────────────────┤
│   状態管理レイヤー (Zustand Store)   │ ← アプリケーション状態
├─────────────────────────────────────┤
│   サービスレイヤー (Services)        │ ← ビジネスロジック
├─────────────────────────────────────┤
│   データレイヤー (LocalStorage)      │ ← データ永続化
└─────────────────────────────────────┘
```

#### UIレイヤー (React Components)
- **責務**: ユーザーイベントの処理、UIの描画、視覚的フィードバック
- **許可される操作**:
  - Zustand Storeからの状態読み取り
  - Storeのアクション呼び出し
  - イベントハンドラの実装
- **禁止される操作**:
  - LocalStorageへの直接アクセス
  - ビジネスロジックの実装（Serviceレイヤーで実装）

#### 状態管理レイヤー (Zustand Store)
- **責務**: アプリケーション全体の状態管理、状態の一元化
- **許可される操作**:
  - 状態の読み取り・更新
  - Serviceレイヤーの呼び出し
- **禁止される操作**:
  - UIコンポーネントへの直接的な依存

#### サービスレイヤー (Services)
- **責務**: ビジネスロジックの実装、データ変換、バリデーション
- **許可される操作**:
  - データレイヤー（LocalStorage）へのアクセス
  - 自然言語パース
  - タスクの作成・更新・削除ロジック
- **禁止される操作**:
  - UIへの直接的な依存

#### データレイヤー (LocalStorage)
- **責務**: データの永続化、読み込み
- **許可される操作**:
  - LocalStorage API呼び出し
  - JSON シリアライズ・デシリアライズ
- **禁止される操作**:
  - ビジネスロジックの実装

## データ永続化戦略

### ストレージ方式

| データ種別 | ストレージ | フォーマット | 理由 |
|-----------|----------|-------------|------|
| タスクデータ | LocalStorage | JSON | サーバー不要。プライバシー保護。オフライン動作。5MB容量で十分（500タスク想定） |
| アプリ設定 | LocalStorage | JSON | ユーザー設定（テーマ、ショートカット等）を保存 |

**LocalStorageキー**:
- `matrixtask-data`: タスクデータ
- `matrixtask-version`: データスキーマバージョン

### データマイグレーション

**バージョン管理**:
```typescript
interface StorageData {
  version: string;  // 例: "1.0.0"
  tasks: Task[];
}
```

**マイグレーション戦略**:
1. アプリ起動時にバージョンチェック
2. 旧バージョンの場合、自動マイグレーション実行
3. マイグレーション前のデータをバックアップ

### バックアップ戦略

- **頻度**: ユーザーが手動でエクスポート可能（MVP）
- **保存先**: ユーザーのダウンロードフォルダ
- **フォーマット**: JSON、Markdown
- **復元方法**: エクスポートしたJSONファイルをインポート（Post-MVP）

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標時間 | 測定環境 |
|------|---------|---------|
| 初回ロード | 2秒以内 | Chrome最新版、ブロードバンド接続 |
| タスク追加 | 100ms以内 | UIが即座に更新される |
| ドラッグ&ドロップ | 60fps（16ms/frame） | アニメーションが滑らか |
| タスク一覧表示 | 500タスクまで遅延なし | スクロールが滑らか |
| LocalStorage保存 | 50ms以内 | 500タスクの保存 |

**測定方法**:
- Chrome DevTools Performance タブで計測
- Lighthouse でパフォーマンススコア90以上

### リソース使用量

| リソース | 上限 | 理由 |
|---------|------|------|
| メモリ | 100MB以内 | 一般的なWebアプリの標準範囲内 |
| LocalStorage | 2MB以内（5MB上限の40%） | 500タスク想定で十分な余裕 |
| バンドルサイズ | 500KB以内（gzip後） | 初回ロード時間を2秒以内に保つため |

## セキュリティアーキテクチャ

### データ保護

- **暗号化**: MVP段階では未実装。Post-MVPでWeb Crypto APIによるローカル暗号化を検討
- **アクセス制御**: LocalStorageはオリジン単位で分離されており、他のサイトからアクセス不可
- **機密情報管理**: MVPではサーバー通信なし。APIキー等の機密情報は存在しない

### 入力検証

- **バリデーション**:
  - タスクタイトル: 1-200文字
  - タスク説明: 0-2000文字
  - タグ: 1-50文字、最大10個
  - 日付: 妥当な日付形式（ISO 8601）
- **サニタイゼーション**:
  - Reactのデフォルトエスケープ機能を活用
  - `dangerouslySetInnerHTML` は使用禁止
  - ユーザー入力はすべてトリム処理
- **エラーハンドリング**:
  - エラーメッセージにシステム内部情報を含めない
  - ユーザーフレンドリーなメッセージを表示

### XSS対策

```typescript
// ❌ 危険: dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: task.title }} />

// ✅ 安全: Reactのデフォルトエスケープ
<div>{task.title}</div>
```

## スケーラビリティ設計

### データ増加への対応

- **想定データ量**: 500タスク（MVP）、将来的に5000タスクまで対応
- **パフォーマンス劣化対策**:
  - React.memoによる不要な再レンダリング防止
  - 仮想スクロール（Post-MVP、1000タスク以上で検討）
  - インデックス作成（ID、象限、日付でのフィルタリング高速化）
- **アーカイブ戦略**:
  - 完了後30日経過したタスクは「アーカイブ」に移動（Post-MVP）
  - アーカイブは別のLocalStorageキーで管理

### 機能拡張性

- **プラグインシステム**: MVP段階では未実装。将来的にカスタムテーマやショートカットの拡張を検討
- **設定のカスタマイズ**:
  - テーマ（ライト/ダーク）
  - ショートカットキーのカスタマイズ
  - 象限の色変更
- **API拡張性**:
  - サービスレイヤーをインターフェース化し、LocalStorage以外（Firebase、Supabase等）への移行を容易に
  - データレイヤーを抽象化（StorageAdapter パターン）

```typescript
// 将来的な拡張例
interface StorageAdapter {
  save(tasks: Task[]): Promise<void>;
  load(): Promise<Task[]>;
}

class LocalStorageAdapter implements StorageAdapter {
  // LocalStorageの実装
}

class FirebaseAdapter implements StorageAdapter {
  // Firebaseの実装（Post-MVP）
}
```

## テスト戦略

### ユニットテスト
- **フレームワーク**: Vitest
- **対象**:
  - Serviceレイヤー（TaskService, NaturalLanguageParser, StorageService）
  - ビジネスロジック
  - ユーティリティ関数（日付変換、バリデーション）
- **カバレッジ目標**: 80%以上

**例**:
```typescript
describe('NaturalLanguageParser', () => {
  it('should extract due date from "明日"', () => {
    const parser = new NaturalLanguageParser();
    const result = parser.parse('明日までにレポート');

    expect(result.title).toBe('までにレポート');
    expect(result.dueDate).toEqual(tomorrow());
  });
});
```

### 統合テスト
- **方法**: React Testing Library
- **対象**:
  - コンポーネントとStoreの連携
  - ドラッグ&ドロップ操作
  - モーダルの開閉
  - LocalStorageへの保存・読み込み

### E2Eテスト
- **ツール**: Playwright
- **シナリオ**:
  1. 初回アクセス時に空の状態が表示される
  2. 受信箱にタスクを追加できる
  3. タスクをマトリクスに分類できる
  4. タスクを「今日やること」にピン留めできる
  5. タスクを完了できる
  6. ページリロード後もデータが保持される

## 技術的制約

### 環境要件
- **ブラウザ**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **画面解像度**: 最小1280x720（デスクトップ想定）
- **JavaScript**: 有効化必須
- **LocalStorage**: 有効化必須、5MB容量
- **必要な外部依存**: なし（CDN不使用、すべてバンドル）

### パフォーマンス制約
- タスク数500件を超えると、パフォーマンス劣化の可能性（仮想スクロール導入で対応）
- LocalStorage 5MBの容量制限（1タスク約4KBと仮定すると、約1250タスクが上限）
- ドラッグ&ドロップは同時1タスクのみ（複数選択は未サポート）

### セキュリティ制約
- LocalStorageは暗号化されていないため、機密情報（パスワード、個人情報）の保存は非推奨
- ブラウザを共有している場合、他のユーザーからデータが見える可能性
- ブラウザのキャッシュクリア時にデータが消失する（エクスポート機能で対応）

## 依存関係管理

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| react | UIフレームワーク | ^18.0.0（マイナーバージョンアップ自動） |
| react-dom | ReactのDOM操作 | ^18.0.0（reactと同期） |
| zustand | 状態管理 | ^4.0.0（マイナーバージョンアップ自動） |
| @dnd-kit/core | ドラッグ&ドロップコア | ^6.0.0（マイナーバージョンアップ自動） |
| @dnd-kit/sortable | ソート可能リスト | ^8.0.0（マイナーバージョンアップ自動） |
| tailwindcss | CSSフレームワーク | ^3.0.0（マイナーバージョンアップ自動） |
| date-fns | 日付処理 | ^3.0.0（マイナーバージョンアップ自動） |
| typescript | 型チェック | ~5.3.0（パッチバージョンのみ自動） |
| vite | ビルドツール | ^5.0.0（マイナーバージョンアップ自動） |
| vitest | テスト | ^1.0.0（マイナーバージョンアップ自動） |
| eslint | Linter | ^9.0.0（マイナーバージョンアップ自動） |
| prettier | フォーマッター | ^3.0.0（マイナーバージョンアップ自動） |

**管理方針**:
- 安定版ライブラリは`^`でマイナーバージョンまで自動更新
- TypeScriptは`~`でパッチバージョンのみ自動（破壊的変更を避ける）
- 月次でdependabot等で依存関係の更新チェック
- セキュリティパッチは即座に適用

## デプロイ戦略

### ホスティング
- **候補**: Vercel、Netlify、GitHub Pages
- **選定理由**:
  - 静的サイトホスティングで十分（サーバーサイド不要）
  - 自動デプロイ（Gitプッシュで自動ビルド）
  - 無料枠で十分（個人利用想定）
  - CDN配信で高速

### ビルドプロセス
```bash
# 本番ビルド
npm run build

# 生成物: dist/
# - index.html
# - assets/*.js (gzip圧縮済み)
# - assets/*.css (minify済み)
```

### 環境変数
MVP段階では環境変数なし。将来的にAPI連携する場合、以下を検討:
```bash
VITE_API_ENDPOINT=https://api.matrixtask.com
```

## 監視・ログ戦略

### エラーログ
- **ツール**: Post-MVPでSentry導入を検討
- **対象**:
  - JavaScriptエラー
  - LocalStorage保存失敗
  - パース失敗

### パフォーマンス監視
- **ツール**: Lighthouse CI、Web Vitals
- **指標**:
  - First Contentful Paint (FCP) < 1.8s
  - Largest Contentful Paint (LCP) < 2.5s
  - Cumulative Layout Shift (CLS) < 0.1
  - First Input Delay (FID) < 100ms

## 今後の拡張予定

### フェーズ2（3ヶ月後）
- タイムライン機能
- ポモドーロタイマー統合
- 週次レビュー機能

### フェーズ3（6ヶ月後）
- クラウド同期（Firebase/Supabase）
- モバイル対応（レスポンシブデザイン）
- PWA対応（オフラインキャッシュ）

### フェーズ4（1年後）
- AI分類提案
- チーム機能（複数ユーザー共有）
- サードパーティ統合（Google Calendar、Slack）
